class SimpleLens{constructor(e,t,s,i,n,o,r){this.focalLength=e,this.startY=t,this.width=s,this.centerPoint=i,this.lensHeight=n,this.scene=o,this.title=r,this.faceMat=new THREE.MeshLambertMaterial({color:16738740,wireframe:!1,side:THREE.DoubleSide,transparent:!0,opacity:.5})}drawLens(){this.lensShape=new THREE.SphereGeometry(.5,16,12),this.lensShape.applyMatrix((new THREE.Matrix4).makeScale(2.75*this.width,.5,2.5*this.width)),this.lensMat=new THREE.MeshBasicMaterial({color:10875635,wireframe:!1}),this.lensMesh=new THREE.Mesh(this.lensShape,this.lensMat),this.lensMesh.position.y=-this.lensHeight-this.startY,this.scene.add(this.lensMesh)}drawRays(){let e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(this.width,0-this.startY,0)),e.vertices.push(new THREE.Vector3(-this.width,0-this.startY,0)),e.vertices.push(new THREE.Vector3(0,0-this.startY,this.width)),e.vertices.push(new THREE.Vector3(0,-this.lensHeight+this.focalLength-this.startY)),e.vertices.push(new THREE.Vector3(0,0-this.startY,-this.width)),e.vertices.push(new THREE.Vector3(0,-this.lensHeight-this.startY,this.width)),e.vertices.push(new THREE.Vector3(-this.width,-this.lensHeight-this.startY,0)),e.vertices.push(new THREE.Vector3(this.width,-this.lensHeight-this.startY,0)),e.vertices.push(new THREE.Vector3(0,-this.lensHeight-this.startY,-this.width)),e.vertices.push(new THREE.Vector3(0,-this.lensHeight-this.startY-this.focalLength,0)),e.vertices.push(new THREE.Vector3(-this.width,-2*this.lensHeight-this.startY,0)),e.vertices.push(new THREE.Vector3(0,-2*this.lensHeight-this.startY,this.width)),e.vertices.push(new THREE.Vector3(this.width,-2*this.lensHeight-this.startY,0)),e.faces.push(new THREE.Face3(1,2,3)),e.faces.push(new THREE.Face3(3,2,0)),e.faces.push(new THREE.Face3(1,4,3)),e.faces.push(new THREE.Face3(3,4,0)),e.faces.push(new THREE.Face3(3,5,6)),e.faces.push(new THREE.Face3(3,5,7)),e.faces.push(new THREE.Face3(3,6,8)),e.faces.push(new THREE.Face3(9,8,6)),e.faces.push(new THREE.Face3(9,5,6)),e.faces.push(new THREE.Face3(9,7,5)),e.faces.push(new THREE.Face3(9,8,7)),e.faces.push(new THREE.Face3(9,10,11)),e.faces.push(new THREE.Face3(9,11,12)),e.faces.push(new THREE.Face3(9,10,11)),e.computeFaceNormals(),e.computeVertexNormals(),this.ray=new THREE.Mesh(e,this.faceMat),this.scene.add(this.ray)}draw(){this.drawLens(),this.drawRays()}getTitle(){return this.title}getMiddle(){return this.lensHeight+this.startY}getStartY(){return 2*this.lensHeight+this.startY}updateFocalLength(e){this.scene.remove(this.ray),this.ray=null,this.focalLength=Number(e),this.rayShape=null,this.draw()}}class AngledLens extends SimpleLens{constructor(e,t,s,i,n,o,r,h,c){super(e,t,s,i,n,h,c),this.scene=h,this.x1=o,this.x2=r}drawRays(){let e=new THREE.Geometry,t=(Number(this.x1)+Number(this.x2))/2;e.vertices.push(new THREE.Vector3(this.width,0-this.startY,0)),e.vertices.push(new THREE.Vector3(-this.width,0-this.startY,0)),e.vertices.push(new THREE.Vector3(0,0-this.startY,this.width)),e.vertices.push(new THREE.Vector3(0,-this.lensHeight+this.focalLength-this.startY)),e.vertices.push(new THREE.Vector3(0,0-this.startY,-this.width)),e.vertices.push(new THREE.Vector3(t,-this.lensHeight-this.startY,this.width)),e.vertices.push(new THREE.Vector3(this.x1,-this.lensHeight-this.startY,0)),e.vertices.push(new THREE.Vector3(this.x2,-this.lensHeight-this.startY,0)),e.vertices.push(new THREE.Vector3(t,-this.lensHeight-this.startY,-this.width)),e.vertices.push(new THREE.Vector3(0,-this.lensHeight-this.startY-this.focalLength,0)),e.vertices.push(new THREE.Vector3(-this.width,-2*this.lensHeight-this.startY,0)),e.vertices.push(new THREE.Vector3(0,-2*this.lensHeight-this.startY,this.width)),e.vertices.push(new THREE.Vector3(this.width,-2*this.lensHeight-this.startY,0)),e.faces.push(new THREE.Face3(1,2,3)),e.faces.push(new THREE.Face3(3,2,0)),e.faces.push(new THREE.Face3(1,4,3)),e.faces.push(new THREE.Face3(3,4,0)),e.faces.push(new THREE.Face3(3,5,6)),e.faces.push(new THREE.Face3(3,5,7)),e.faces.push(new THREE.Face3(3,6,8)),e.faces.push(new THREE.Face3(9,8,6)),e.faces.push(new THREE.Face3(9,5,6)),e.faces.push(new THREE.Face3(9,7,5)),e.faces.push(new THREE.Face3(9,8,7)),e.faces.push(new THREE.Face3(9,10,11)),e.faces.push(new THREE.Face3(9,11,12)),e.faces.push(new THREE.Face3(9,10,11)),e.computeFaceNormals(),e.computeVertexNormals(),this.ray=new THREE.Mesh(e,this.faceMat),this.scene.add(this.ray)}updatex1(e){this.scene.remove(this.ray),this.ray=null,this.x1=e,this.rayShape=null,this.drawRays()}updatex2(e){this.scene.remove(this.ray),this.ray=null,this.x2=e,this.rayShape=null,this.drawRays()}}class Column{constructor(e,t){this.components=new Array,this.height=e,this.cMaterial=new THREE.CylinderGeometry(10,10,this.height,20,1,!0,1.5,3),this.cGeometry=new THREE.MeshPhongMaterial({side:THREE.FrontSide,shadowSide:THREE.BackSide,wireframe:!1,color:16777215}),this.scene=t,this.width=2.5,this.lineMaterial=new THREE.LineBasicMaterial({color:16711680,side:THREE.DoubleSide}),this.lineGeometry=new THREE.Geometry,this.cMaterial.computeFaceNormals(),this.cMaterial.computeVertexNormals(),this.cMesh=new THREE.Mesh(this.cMaterial,this.cGeometry),this.cMesh.position.y=this.height/2,this.init=this.init.bind(this)}addSimpleLens(e,t,s){let i=0;0!=this.components.length&&(i=this.components[this.components.length-1].getStartY());let n=new SimpleLens(e,i,this.width,0,t,this.scene,s);this.components.push(n)}addAngledLens(e,t,s,i,n){let o=0;0!=this.components.length&&(o=this.components[this.components.length-1].getStartY());let r=new AngledLens(e,o,this.width,0,t,s,i,this.scene,n);this.components.push(r)}drawLenses(){for(let e=0;e<this.components.length;++e)this.components[e].draw()}drawColumn(){this.scene.add(this.cMesh),this.lineGeometry.vertices.push(new THREE.Vector3(0,0,0)),this.lineGeometry.vertices.push(new THREE.Vector3(0,-45,0)),this.line=new THREE.Line(this.lineGeometry,this.lineMaterial),this.scene.add(this.line)}focusColumn(e){return this.components[e].getMiddle()}getTitle(e){return this.components[e].getTitle()}init(){this.drawColumn()}updateFocalLength(e,t){this.components[e].updateFocalLength(t)}updateLeftBoundry(e,t){this.components[e].updatex1(t)}updateRightBoundry(e,t){this.components[e].updatex2(t)}}class MicroscopeColumn{constructor(e){null===document.getElementById(e)?console.error("ERROR: Couldn't find the provided div "+e):(this.window=$("#"+e),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(15,1,.1,1500),this.controls,this.renderer,this.columnHeight=-45,this.animate=this.animate.bind(this),this.init=this.init.bind(this),this.render=this.render.bind(this),this.sceneHeight=this.window.height()-35,this.init(),this.animate(),this.drawScene())}init(){this.initTitle(),this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(this.window.width(),this.sceneHeight),this.renderer.domElement.id="threeCanvas",this.window.append(this.renderer.domElement),this.controls=new THREE.TrackballControls(this.camera,document.getElementById("threeCanvas")),this.camera.position.z=200,this.camera.position.y=0,this.camera.position.x=0,this.controls.target=new THREE.Vector3(0,this.columnHeight/2,0),this.initLights(),this.initColumn(),this.controls.addEventListener("change",this.render)}initTitle(){this.titleSpace=$("<div>w</div>"),this.titleSpace.css("background","#00cbcc"),this.titleSpace.css("color","#00cbcc"),this.titleSpace.css("font-size","0.5em"),this.title=$("<div>Overall Column</div>"),this.title.css("padding-top","0.25em"),this.title.css("padding-left","1em"),this.title.css("padding-bottom","0.25em"),this.title.css("background","#18ffff"),this.title.css("font-family","Roboto,Noto,sans-serif"),this.title.css("box-shadow","30px, 30px, 3px, white"),this.window.append(this.titleSpace),this.window.append(this.title)}initLights(){new THREE.PointLight(new THREE.Color("hsl(0, 100%, 100%)"),1.4).position.set(0,0,-140);let e=new THREE.DirectionalLight(new THREE.Color("hsl(285, 100%, 100%)"),1);e.position.set(-5,-20,10).normalize(),e.target.position.set(0,-20,0),new THREE.DirectionalLight(new THREE.Color("hsl(58, 100%, 100%)"),1).position.set(0,0,50),new THREE.DirectionalLight(new THREE.Color("hsl(338, 100%, 100%)"),1).position.set(0,10,0).normalize(),this.scene.add(e)}initColumn(){this.microscope=new Column(this.columnHeight,this.scene),this.createLenses()}render(){this.renderer.render(this.scene,this.camera)}drawScene(){this.microscope.init(),this.render()}animate(){requestAnimationFrame(this.animate),this.controls.update()}createLenses(){this.microscope.addSimpleLens(1.2,3,"First Lens"),this.microscope.addSimpleLens(2,5,"Second Lens"),this.microscope.addSimpleLens(2,5,"Third Lens"),this.microscope.addSimpleLens(2,5,"Fourth Lens"),this.microscope.addAngledLens(2,3,-2,-1,"Fifth Lens"),this.microscope.drawLenses()}updateFocalLength(e,t){this.microscope.updateFocalLength(e,t),this.render()}updateLeftBoundry(e,t){this.microscope.updateLeftBoundry(e,t),this.render()}updateRightBoundry(e,t){this.microscope.updateRightBoundry(e,t),this.render()}focusColumn(e){let t=-this.microscope.focusColumn(e),s=this.microscope.getTitle(e);this.camera.position.y=t,this.controls.target.y=t,this.camera.position.z=50,this.title.text(s),this.render()}}THREE.TrackballControls=function(e,t){var s=this,i={NONE:-1,ZOOM:1,PAN:2,ROTATEX:3,ROTATEY:4,TOUCH_ROTATE:5,TOUCH_ZOOM_PAN:6};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68,17,18],this.mouseDown=!1,this.target=new THREE.Vector3;var n=new THREE.Vector3,o=i.NONE,r=i.NONE,h=new THREE.Vector3,c=new THREE.Vector2,a=new THREE.Vector2,l=new THREE.Vector3,p=0,u=new THREE.Vector2,d=new THREE.Vector2,E=0,m=0,y=new THREE.Vector2,w=new THREE.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var g={type:"change"},v={type:"start"},f={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var T,R,H,x,b,V,L,M,Y,N,P,S=(T=new THREE.Vector2,function(e,t){return T.set((e-s.screen.left)/s.screen.width,(t-s.screen.top)/s.screen.height),T}),z=function(){var e=new THREE.Vector2;return function(t,i){return e.set((t-.5*s.screen.width-s.screen.left)/(.5*s.screen.width),(s.screen.height+2*(s.screen.top-i))/s.screen.width),e}}();function F(e){!1!==s.enabled&&(console.log(o),window.removeEventListener("keydown",F),r=o,o===i.NONE&&(e.keyCode!==s.keys[i.ROTATEX]||s.noRotate?e.keyCode!==s.keys[i.ROTATEY]||s.noRotate?e.keyCode!==s.keys[i.ZOOM]||s.noZoom?e.keyCode!==s.keys[i.PAN]||s.noPan||(o=i.PAN):o=i.ZOOM:o=i.ROTATEY:o=i.ROTATEX))}function k(e){!1!==s.enabled&&(e.ctrlKey||e.shiftKey||s.mouseup(e),o=r,window.addEventListener("keydown",F,!1))}function O(e){!1!==s.enabled&&(e.preventDefault(),e.stopPropagation(),this.mouseDown=!0,o===i.NONE&&(o=e.button),e.ctrlKey?o=i.ROTATEX:e.shiftKey&&(o=i.ROTATEY),o!==i.ROTATEX||s.noRotate?o!==i.ROTATEY||s.noRotate?o!==i.ZOOM||s.noZoom?o!==i.PAN||s.noPan||(y.copy(S(e.pageX,e.pageY)),w.copy(y)):(u.copy(S(e.pageX,e.pageY)),d.copy(u)):(a.copy(z(0,e.pageY)),c.copy(a)):(a.copy(z(e.pageX,0)),c.copy(a)),document.addEventListener("mousemove",C,!1),document.addEventListener("mouseup",s.mouseup,!1),s.dispatchEvent(v))}function C(e){!1!==s.enabled&&(e.preventDefault(),e.stopPropagation(),o!==i.ROTATEX||s.noRotate?o!==i.ROTATEY||s.noRotate?o!==i.ZOOM||s.noZoom?o!==i.PAN||s.noPan||w.copy(S(e.pageX,e.pageY)):d.copy(S(e.pageX,e.pageY)):(c.copy(a),a.copy(z(0,e.pageY))):(c.copy(a),a.copy(z(e.pageX,0))))}function A(e){if(!1!==s.enabled){switch(e.preventDefault(),e.stopPropagation(),e.deltaMode){case 2:u.y-=.025*e.deltaY;break;case 1:u.y-=.01*e.deltaY;break;default:u.y-=25e-5*e.deltaY}s.dispatchEvent(v),s.dispatchEvent(f)}}function D(e){if(!1!==s.enabled){switch(e.touches.length){case 1:o=i.TOUCH_ROTATE,a.copy(z(e.touches[0].pageX,e.touches[0].pageY)),c.copy(a);break;default:o=i.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;m=E=Math.sqrt(t*t+n*n);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,h=(e.touches[0].pageY+e.touches[1].pageY)/2;y.copy(S(r,h)),w.copy(y)}s.dispatchEvent(v)}}function j(e){if(!1!==s.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:c.copy(a),a.copy(z(e.touches[0].pageX,e.touches[0].pageY));break;default:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;m=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;w.copy(S(n,o))}}function X(e){if(!1!==s.enabled){switch(e.touches.length){case 0:o=i.NONE;break;case 1:o=i.TOUCH_ROTATE,a.copy(z(e.touches[0].pageX,e.touches[0].pageY)),c.copy(a)}s.dispatchEvent(f)}}function G(e){!1!==s.enabled&&e.preventDefault()}this.rotateCamera=(H=new THREE.Vector3,x=new THREE.Quaternion,b=new THREE.Vector3,V=new THREE.Vector3,L=new THREE.Vector3,M=new THREE.Vector3,function(e){M.set(a.x-c.x,a.y-c.y,0),(R=M.length())?(h.copy(s.object.position).sub(s.target),b.copy(h).normalize(),V.copy(s.object.up).normalize(),L.crossVectors(V,b).normalize(),V.setLength(a.y-c.y),L.setLength(a.x-c.x),M.copy(V.add(L)),H.crossVectors(M,h).normalize(),R*=s.rotateSpeed,x.setFromAxisAngle(H,R),h.applyQuaternion(x),s.object.up.applyQuaternion(x),l.copy(H),p=R):!s.staticMoving&&p&&(p*=Math.sqrt(1-s.dynamicDampingFactor),h.copy(s.object.position).sub(s.target),x.setFromAxisAngle(l,p),h.applyQuaternion(x),s.object.up.applyQuaternion(x)),c.copy(a)}),this.zoomCamera=function(){var e;o===i.TOUCH_ZOOM_PAN?(e=E/m,E=m,h.multiplyScalar(e)):(1!==(e=1+(d.y-u.y)*s.zoomSpeed)&&e>0&&h.multiplyScalar(e),s.staticMoving?u.copy(d):u.y+=(d.y-u.y)*this.dynamicDampingFactor)},this.panCamera=(Y=new THREE.Vector2,N=new THREE.Vector3,P=new THREE.Vector3,function(){Y.copy(w).sub(y),Y.lengthSq()&&(Y.multiplyScalar(h.length()*s.panSpeed),P.copy(h).cross(s.object.up).setLength(Y.x),P.add(N.copy(s.object.up).setLength(Y.y)),s.object.position.add(P),s.target.add(P),s.staticMoving?y.copy(w):y.add(Y.subVectors(w,y).multiplyScalar(s.dynamicDampingFactor)))}),this.checkDistances=function(){s.noZoom&&s.noPan||(h.lengthSq()>s.maxDistance*s.maxDistance&&(s.object.position.addVectors(s.target,h.setLength(s.maxDistance)),u.copy(d)),h.lengthSq()<s.minDistance*s.minDistance&&(s.object.position.addVectors(s.target,h.setLength(s.minDistance)),u.copy(d)))},this.update=function(){h.subVectors(s.object.position,s.target),s.noRotate||s.rotateCamera(),s.noZoom||s.zoomCamera(),s.noPan||s.panCamera(),s.object.position.addVectors(s.target,h),s.checkDistances(),s.object.lookAt(s.target),n.distanceToSquared(s.object.position)>1e-6&&(s.dispatchEvent(g),n.copy(s.object.position))},this.reset=function(){o=i.NONE,r=i.NONE,s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.up.copy(s.up0),h.subVectors(s.object.position,s.target),s.object.lookAt(s.target),s.dispatchEvent(g),n.copy(s.object.position)},this.mouseup=function(e){if(this.mouseDown=!1,o=i.NONE,!e.ctrlKey&&!e.shiftKey){if(!1===s.enabled)return;e.preventDefault(),e.stopPropagation(),document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",s.mouseup),s.dispatchEvent(f)}},this.dispose=function(){this.domElement.removeEventListener("contextmenu",G,!1),this.domElement.removeEventListener("mousedown",O,!1),this.domElement.removeEventListener("wheel",A,!1),this.domElement.removeEventListener("touchstart",D,!1),this.domElement.removeEventListener("touchend",X,!1),this.domElement.removeEventListener("touchmove",j,!1),document.removeEventListener("mousemove",C,!1),document.removeEventListener("mouseup",mouseup,!1),window.removeEventListener("keydown",F,!1),window.removeEventListener("keyup",k,!1)},this.domElement.addEventListener("contextmenu",G,!1),this.domElement.addEventListener("mousedown",O,!1),this.domElement.addEventListener("wheel",A,!1),this.domElement.addEventListener("touchstart",D,!1),this.domElement.addEventListener("touchend",X,!1),this.domElement.addEventListener("touchmove",j,!1),window.addEventListener("keydown",F,!1),window.addEventListener("keyup",k,!1),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls,window.ThreeBSP=function(){var e;return(e=function(t){var s,i,n,o,r,h,c,a=[];if(t instanceof THREE.Geometry)this.matrix=new THREE.Matrix4;else{if(!(t instanceof THREE.Mesh)){if(t instanceof e.Node)return this.tree=t,this.matrix=new THREE.Matrix4,this;throw"ThreeBSP: Given geometry is unsupported"}t.updateMatrix(),this.matrix=t.matrix.clone(),t=t.geometry}for(s=0,i=t.faces.length;s<i;s++)n=t.faces[s],r=t.faceVertexUvs[0][s],c=new e.Polygon,n instanceof THREE.Face3?(o=t.vertices[n.a],h=r?new THREE.Vector2(r[0].x,r[0].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[0],h)).applyMatrix4(this.matrix),c.vertices.push(o),o=t.vertices[n.b],h=r?new THREE.Vector2(r[1].x,r[1].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[1],h)).applyMatrix4(this.matrix),c.vertices.push(o),o=t.vertices[n.c],h=r?new THREE.Vector2(r[2].x,r[2].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[2],h)).applyMatrix4(this.matrix),c.vertices.push(o)):(THREE.Face4,o=t.vertices[n.a],h=r?new THREE.Vector2(r[0].x,r[0].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[0],h)).applyMatrix4(this.matrix),c.vertices.push(o),o=t.vertices[n.b],h=r?new THREE.Vector2(r[1].x,r[1].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[1],h)).applyMatrix4(this.matrix),c.vertices.push(o),o=t.vertices[n.c],h=r?new THREE.Vector2(r[2].x,r[2].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[2],h)).applyMatrix4(this.matrix),c.vertices.push(o),o=t.vertices[n.d],h=r?new THREE.Vector2(r[3].x,r[3].y):null,(o=new e.Vertex(o.x,o.y,o.z,n.vertexNormals[3],h)).applyMatrix4(this.matrix),c.vertices.push(o)),c.calculateProperties(),a.push(c);this.tree=new e.Node(a)}).prototype.subtract=function(t){var s=this.tree.clone(),i=t.tree.clone();return s.invert(),s.clipTo(i),i.clipTo(s),i.invert(),i.clipTo(s),i.invert(),s.build(i.allPolygons()),s.invert(),(s=new e(s)).matrix=this.matrix,s},e.prototype.union=function(t){var s=this.tree.clone(),i=t.tree.clone();return s.clipTo(i),i.clipTo(s),i.invert(),i.clipTo(s),i.invert(),s.build(i.allPolygons()),(s=new e(s)).matrix=this.matrix,s},e.prototype.intersect=function(t){var s=this.tree.clone(),i=t.tree.clone();return s.invert(),i.clipTo(s),i.invert(),s.clipTo(i),i.clipTo(s),s.build(i.allPolygons()),s.invert(),(s=new e(s)).matrix=this.matrix,s},e.prototype.toGeometry=function(){var e,t,s,i,n,o,r,h,c,a,l=(new THREE.Matrix4).getInverse(this.matrix),p=new THREE.Geometry,u=this.tree.allPolygons(),d=u.length,E={};for(e=0;e<d;e++)for(i=(s=u[e]).vertices.length,t=2;t<i;t++)a=[],h=s.vertices[0],a.push(new THREE.Vector2(h.uv.x,h.uv.y)),(h=new THREE.Vector3(h.x,h.y,h.z)).applyMatrix4(l),void 0!==E[h.x+","+h.y+","+h.z]?n=E[h.x+","+h.y+","+h.z]:(p.vertices.push(h),n=E[h.x+","+h.y+","+h.z]=p.vertices.length-1),h=s.vertices[t-1],a.push(new THREE.Vector2(h.uv.x,h.uv.y)),(h=new THREE.Vector3(h.x,h.y,h.z)).applyMatrix4(l),void 0!==E[h.x+","+h.y+","+h.z]?o=E[h.x+","+h.y+","+h.z]:(p.vertices.push(h),o=E[h.x+","+h.y+","+h.z]=p.vertices.length-1),h=s.vertices[t],a.push(new THREE.Vector2(h.uv.x,h.uv.y)),(h=new THREE.Vector3(h.x,h.y,h.z)).applyMatrix4(l),void 0!==E[h.x+","+h.y+","+h.z]?r=E[h.x+","+h.y+","+h.z]:(p.vertices.push(h),r=E[h.x+","+h.y+","+h.z]=p.vertices.length-1),c=new THREE.Face3(n,o,r,new THREE.Vector3(s.normal.x,s.normal.y,s.normal.z)),p.faces.push(c),p.faceVertexUvs[0].push(a);return p},e.prototype.toMesh=function(e){var t=this.toGeometry(),s=new THREE.Mesh(t,e);return s.position.setFromMatrixPosition(this.matrix),s.rotation.setFromRotationMatrix(this.matrix),s},e.Polygon=function(e,t,s){e instanceof Array||(e=[]),this.vertices=e,e.length>0?this.calculateProperties():this.normal=this.w=void 0},e.Polygon.prototype.calculateProperties=function(){var e=this.vertices[0],t=this.vertices[1],s=this.vertices[2];return this.normal=t.clone().subtract(e).cross(s.clone().subtract(e)).normalize(),this.w=this.normal.clone().dot(e),this},e.Polygon.prototype.clone=function(){var t,s,i=new e.Polygon;for(t=0,s=this.vertices.length;t<s;t++)i.vertices.push(this.vertices[t].clone());return i.calculateProperties(),i},e.Polygon.prototype.flip=function(){var e,t=[];for(this.normal.multiplyScalar(-1),this.w*=-1,e=this.vertices.length-1;e>=0;e--)t.push(this.vertices[e]);return this.vertices=t,this},e.Polygon.prototype.classifyVertex=function(e){var t=this.normal.dot(e)-this.w;return t<-1e-5?2:t>1e-5?1:0},e.Polygon.prototype.classifySide=function(e){var t,s,i,n=0,o=0,r=e.vertices.length;for(t=0;t<r;t++)s=e.vertices[t],1===(i=this.classifyVertex(s))?n++:2===i&&o++;return n>0&&0===o?1:0===n&&o>0?2:0===n&&0===o?0:3},e.Polygon.prototype.splitPolygon=function(t,s,i,n,o){var r=this.classifySide(t);if(0===r)(this.normal.dot(t.normal)>0?s:i).push(t);else if(1===r)n.push(t);else if(2===r)o.push(t);else{var h,c,a,l,p,u,d,E,m,y=[],w=[];for(c=0,h=t.vertices.length;c<h;c++)a=(c+1)%h,u=t.vertices[c],d=t.vertices[a],l=this.classifyVertex(u),p=this.classifyVertex(d),2!=l&&y.push(u),1!=l&&w.push(u),3==(l|p)&&(E=(this.w-this.normal.dot(u))/this.normal.dot(d.clone().subtract(u)),m=u.interpolate(d,E),y.push(m),w.push(m));y.length>=3&&n.push(new e.Polygon(y).calculateProperties()),w.length>=3&&o.push(new e.Polygon(w).calculateProperties())}},e.Vertex=function(e,t,s,i,n){this.x=e,this.y=t,this.z=s,this.normal=i||new THREE.Vector3,this.uv=n||new THREE.Vector2},e.Vertex.prototype.clone=function(){return new e.Vertex(this.x,this.y,this.z,this.normal.clone(),this.uv.clone())},e.Vertex.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},e.Vertex.prototype.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},e.Vertex.prototype.multiplyScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this},e.Vertex.prototype.cross=function(e){var t=this.x,s=this.y,i=this.z;return this.x=s*e.z-i*e.y,this.y=i*e.x-t*e.z,this.z=t*e.y-s*e.x,this},e.Vertex.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return this.x/=e,this.y/=e,this.z/=e,this},e.Vertex.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},e.Vertex.prototype.lerp=function(e,t){return this.add(e.clone().subtract(this).multiplyScalar(t)),this.normal.add(e.normal.clone().sub(this.normal).multiplyScalar(t)),this.uv.add(e.uv.clone().sub(this.uv).multiplyScalar(t)),this},e.Vertex.prototype.interpolate=function(e,t){return this.clone().lerp(e,t)},e.Vertex.prototype.applyMatrix4=function(e){var t=this.x,s=this.y,i=this.z,n=e.elements;return this.x=n[0]*t+n[4]*s+n[8]*i+n[12],this.y=n[1]*t+n[5]*s+n[9]*i+n[13],this.z=n[2]*t+n[6]*s+n[10]*i+n[14],this},e.Node=function(t){var s,i,n=[],o=[];if(this.polygons=[],this.front=this.back=void 0,t instanceof Array&&0!==t.length){for(this.divider=t[0].clone(),s=0,i=t.length;s<i;s++)this.divider.splitPolygon(t[s],this.polygons,this.polygons,n,o);n.length>0&&(this.front=new e.Node(n)),o.length>0&&(this.back=new e.Node(o))}},e.Node.isConvex=function(e){var t,s;for(t=0;t<e.length;t++)for(s=0;s<e.length;s++)if(t!==s&&2!==e[t].classifySide(e[s]))return!1;return!0},e.Node.prototype.build=function(t){var s,i,n=[],o=[];for(this.divider||(this.divider=t[0].clone()),s=0,i=t.length;s<i;s++)this.divider.splitPolygon(t[s],this.polygons,this.polygons,n,o);n.length>0&&(this.front||(this.front=new e.Node),this.front.build(n)),o.length>0&&(this.back||(this.back=new e.Node),this.back.build(o))},e.Node.prototype.allPolygons=function(){var e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e},e.Node.prototype.clone=function(){var t=new e.Node;return t.divider=this.divider.clone(),t.polygons=this.polygons.map(function(e){return e.clone()}),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t},e.Node.prototype.invert=function(){var e,t,s;for(e=0,t=this.polygons.length;e<t;e++)this.polygons[e].flip();return this.divider.flip(),this.front&&this.front.invert(),this.back&&this.back.invert(),s=this.front,this.front=this.back,this.back=s,this},e.Node.prototype.clipPolygons=function(e){var t,s,i,n;if(!this.divider)return e.slice();for(i=[],n=[],t=0,s=e.length;t<s;t++)this.divider.splitPolygon(e[t],i,n,i,n);return this.front&&(i=this.front.clipPolygons(i)),n=this.back?this.back.clipPolygons(n):[],i.concat(n)},e.Node.prototype.clipTo=function(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)},e}();
